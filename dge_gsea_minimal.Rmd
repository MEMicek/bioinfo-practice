---
title: "DGE and GSEA example protocol"
author: "Marta Micek"
date: "2025-12-06"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
#library(rtracklayer)
library(dplyr)
library(airway)
library(GenomeInfoDb)
library(DESeq2)
library(ggplot2)
```

# Intro

A minimal protocol for DGE and GSEA analysis using raw counts as input. 

CTRL+ALT+I to create a new chunk.
CTRL+ENTER runs a line.

```{r}
data <- data("airway")
airway
assay(airway)[1:5, 1:5] # display counts
colData(airway)
rowData(airway)[1:5,]
```

# DESeq2

colData() shows a column called 'dex' that contains treatment information. It's the experiment design. There are also plenty of different approaches regarding filtering genes with overall low signal/expression.

```{r}
dds <- DESeqDataSet(
  airway,
  design = ~ dex
)

dds <- dds[rowSums(counts(dds)) >= 10, ] # remove genes with low signal
dds <- DESeq(dds)

res <- results(dds, contrast = c("dex", "trt", "untrt"))
resOrdered <- res[order(res$pvalue), ]
head(resOrdered)
```

# Volcano

**pmax()** works element-wise. For each adjusted p-value, it returns:

• the p-value itself, if it’s > 2e-308
• otherwise, 2e-308 instead


**.Machine$double.xmin**

This is a built-in R constant. It’s the smallest positive floating-point number R can represent.

The whole expression:

pmax(res$padj, .Machine$double.xmin)
pmax() works element-wise. For each adjusted p-value, it returns:

• the p-value itself, if it’s > 2e-308
• otherwise, 2e-308 instead

pmax checks which number is larger in each pair, so:

So per gene:

if padj is normal → keep it

if padj is 0 → replace it with 2e-308

if padj is negative (shouldn’t happen) → also replaced

if padj is NA → stays NA


```{r volcano}
plot(
  res$log2FoldChange,
  -log10(pmax(res$padj, .Machine$double.xmin)), 
  pch = 20,
  main = "Volcano plot",
  xlab = "log2(Fold Change)",
  ylab = "-log10(adjusted p-value)"
)
```

```{r}
ggplot(as.data.frame(res),
       aes(log2FoldChange, -log10(padj))) +
  geom_point()
```

